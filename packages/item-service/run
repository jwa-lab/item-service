#! /usr/bin/env bash

set -euo pipefail

declare -a tags=(
    $(git rev-parse --verify HEAD --short)
    $(node -p -e "require('./package.json').version")
)

declare name=$(node -p -e "require('./package.json').name.substring(1)")

function docker-build() {
    docker build -t ${name} .
    docker build -t ${name}-init -f init.Dockerfile .
}

function docker-tag() {
    for tag in ${tags[@]}
    do
        docker tag ${name} ${name}:${tag}
        docker tag ${name}-init ${name}-init:${tag}
    done
}

function docker-push() {
    docker push ${name}
    docker push ${name}-init

    for tag in ${tags[@]}
    do
        docker push ${name}:${tag}
        docker push ${name}-init:${tag}
    done
}

"$@"
